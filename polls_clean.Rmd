---
title: "**2020 Presidential Polling**"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(plotly)
library(patchwork)
```

```{r clean_datasets, echo=FALSE, message=FALSE, warning=FALSE}

##Clean Polls and Regional datasets 

polls_df=
  read_csv("./datasets/presidential_state_toplines_2020.csv") %>%
  rename(date = modeldate) %>% 
  mutate(date = as.Date (date, format = "%m/%d/%Y"))%>% 
  separate(date, into = c("year", "month", "day")) %>%  
   select(state, month, day, candidate_chal,
          winstate_chal, voteshare_chal,
          candidate_inc, winstate_inc, voteshare_inc, 
          margin, state_turnout,
          -candidate_chal, -candidate_inc) %>% 
  rename(
    biden_winstate = winstate_chal, 
    biden_voteshare = voteshare_chal,
    trump_winstate = winstate_inc, 
    trump_voteshare = voteshare_inc, 
    voteshare_margin = margin,
    expvote_turnout = state_turnout) %>% 
  arrange(state, month, day)

region_df = 
    read_csv("./datasets/states.csv") %>% 
    rename(state = State)  

## Merge Polls and Regional Data 
polls_merge =
    merge(
    polls_df,
    region_df,
    by = "state") %>% 
  arrange(state, month, day) %>% 
  select(-`State Code`) %>% 
  relocate("state", "Region") %>% 
  view ()
```


## Expected Voter Turnout by State 

Voter turnout was expected to be in record numbers across the country for the 2020 Presidential Election. The bar graph below displays the expected votes (in millions)
by geographical region. 

```{r Clean_Voter_Data, echo=FALSE, message=FALSE, warning=FALSE}

## Clean vote proportion and number of votes for each candidate by state

exp_votes=
  polls_merge %>%
  select (-trump_winstate, -biden_winstate, -voteshare_margin, -Division) %>%
  filter (month == 11) %>% 
  rename (State = state) %>% 
  group_by(Region, State, month) %>%     
  summarize(
    voter_turnout = mean(expvote_turnout),
    prop_Biden = mean(biden_voteshare),
    prop_Trump = mean(trump_voteshare)
    ) %>% 
  pivot_longer(
      prop_Biden:prop_Trump,
      names_to = "Candidate", 
      names_prefix = "prop_",
      values_to = "votes_proportion") %>% 
  mutate(
    candidate_votes = (votes_proportion/100)*voter_turnout
    ) 
  
```

```{r Expected_Total_Votes, echo=FALSE, message=FALSE, warning=FALSE}

## Below is expected voter turnout taking the mean of the first 3 days of November by State  

## Midwestern States 
expvote_plot1 = 
  exp_votes %>%
    filter(Region == "Midwest") %>% 
    ggplot(aes(x = reorder(State, desc(voter_turnout)), y = voter_turnout/1000000)) +
    geom_bar(stat = "identity", position = position_dodge(), fill='steelblue') +
      labs(
        title = "Expected Votes in Midwestern States", 
        x = "State", 
        y = "Total Votes (M)") +
    theme(axis.text.x = element_text(angle=90, vjust=0.5, hjust=1),
          plot.title = element_text(hjust = 0.5))

## Western States 
expvote_plot2 = 
  exp_votes %>%
    filter(Region == "West") %>% 
    ggplot(aes(x = reorder(State, desc(voter_turnout)), y = voter_turnout/1000000)) +
    geom_bar(stat = "identity", position = position_dodge(), 
             fill='steelblue') +
      labs(
        title = "Expected Votes in Western States", 
        x = "State", 
        y = "Total Votes (M)") +
    theme(axis.text.x = element_text(angle=90, vjust=0.5, hjust=1),
          plot.title = element_text(hjust = 0.5))

## Northeastern States 
expvote_plot3 = 
  exp_votes %>%
    filter(Region == "Northeast") %>% 
    ggplot(aes(x = reorder(State, desc(voter_turnout)), y = voter_turnout/1000000)) +
    geom_bar(stat = "identity", position = position_dodge(), fill='steelblue') +
      labs(
        title = "Expected Votes in Northeastern States", 
        x = "State", 
        y = "Total Votes (M)") +
    theme(axis.text.x = element_text(angle=90, vjust=0.5, hjust=1),
          plot.title = element_text(hjust = 0.5))

## Southern States 
expvote_plot4 = 
  exp_votes %>%
    filter(Region == "South") %>% 
    ggplot(aes(x = reorder(State, desc(voter_turnout)), y = voter_turnout/1000000)) +
    geom_bar(stat = "identity", position = position_dodge(), fill='steelblue') +
      labs(
        title = "Expected Votes in Southern States", 
        x = "State", 
        y = "Total Votes (M)") +
    theme(axis.text.x = element_text(angle=90, vjust=0.5, hjust=1),
          plot.title = element_text(hjust = 0.5))

## Plot of expected voter turnout for all US States 
expvote_plot1 + expvote_plot2 + expvote_plot3 + expvote_plot4

## Decimal Places 
options(scipen = 999)
```

***

## Projected Percentage of Votes by Candidate   

The proprotion of votes for each candidate in the 2020 Presidential Race was expected to be marginly thin. The bar graph below show the voting breakdown by state, which will be compared to the final election results. 

```{r Candidate_Prop_Votes, echo=FALSE, message=FALSE, warning=FALSE}
colors <- c("dark red", "dark blue")
names(colors) = c("Trump", "Biden")

mid_prop =
exp_votes %>% 
    filter(Region == "Midwest") %>% 
    ggplot(aes(x = State, y = round(votes_proportion,2), fill = Candidate)) +
    geom_bar(stat = "identity", position = position_dodge()) + 
    labs(x = "Midwest", 
         y = "Vote Proportion") + 
    scale_fill_manual(values = colors) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) 

west_prop =
exp_votes %>% 
    filter(Region == "West") %>% 
    ggplot(aes(x = State, y = round(votes_proportion,2), fill = Candidate)) +
    geom_bar(stat = "identity", position = position_dodge()) + 
    labs(x = "West", 
         y = "Vote Proportion") + 
    scale_fill_manual(values = colors) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) 

south_prop=
exp_votes %>% 
    filter(Region == "South") %>% 
    ggplot(aes(x = State, y = round(votes_proportion,2), fill = Candidate)) +
    geom_bar(stat = "identity", position = position_dodge()) + 
    labs(x = "South", 
         y = "Vote Proportion") + 
    scale_fill_manual(values = colors) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) 

northeast_prop=
exp_votes %>% 
    filter(Region == "Northeast") %>% 
    ggplot(aes(x = State, y = round(votes_proportion,2), fill = Candidate)) +
    geom_bar(stat = "identity", position = position_dodge()) + 
    labs(x = "Northeast", 
         y = "Vote Proportion") + 
    scale_fill_manual(values = colors) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) 

## Combine Proportion Plots 
mid_prop + south_prop + west_prop + northeast_prop + plot_layout(guides = "collect")

```

## Expected Raw Votes by Candidate    

This bar graph is to provide additional information for The expected number  of votes for each candidate in the 2020 Presidential Race was expected to be marginly thin. The bar graph below show the voting breakdown by state. 

```{r Candidate_Total_Votes, echo=FALSE, message=FALSE, warning=FALSE}
colors <- c("dark red", "dark blue")
names(colors) = c("Trump", "Biden")

mid_plot =
exp_votes %>% 
    filter(Region == "Midwest") %>% 
    ggplot(aes(x = State, y = candidate_votes/1000000, fill = Candidate)) +
    geom_bar(stat = "identity", position = position_dodge()) + 
    labs(x = "Midwest", 
         y = "Number of Votes(M)") + 
    scale_fill_manual(values = colors) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) 

west_plot =
exp_votes %>% 
    filter(Region == "West") %>% 
    ggplot(aes(x = State, y = candidate_votes/1000000, fill = Candidate)) +
    geom_bar(stat = "identity", position = position_dodge()) + 
    labs(x = "West", 
         y = "Number of Votes(M)") + 
    scale_fill_manual(values = colors) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) 

south_plot=
exp_votes %>% 
    filter(Region == "South") %>% 
    ggplot(aes(x = State, y = candidate_votes/1000000, fill = Candidate)) +
    geom_bar(stat = "identity", position = position_dodge()) + 
    labs(x = "South", 
         y = "Number of Votes(M)") + 
    scale_fill_manual(values = colors) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) 

northeast_plot=
exp_votes %>% 
    filter(Region == "Northeast") %>% 
    ggplot(aes(x = State, y = candidate_votes/1000000, fill = Candidate)) +
    geom_bar(stat = "identity", position = position_dodge()) + 
    labs(x = "Northeast", 
         y = "Number of Votes(M)") + 
    scale_fill_manual(values = colors) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) 

## Combine raw votes per state for each candidate 
mid_plot + south_plot + west_plot + northeast_plot + plot_layout(guides = "collect")
```


Text describing voter margin by state for each candidate 

```{r Voteshare_Margin, echo=FALSE, message=FALSE, warning=FALSE}

vote_margin=
  polls_merge %>% 
  select (state, Region, month, day, voteshare_margin) %>% 
  drop_na() %>% 
  group_by(Region, state, month) %>%     
  summarize(
    month_avg = mean(voteshare_margin)) %>% 
  filter(month == 11) 

margin_plot1 = 
  vote_margin %>%
  filter(Region == "South") %>% 
    ggplot(aes(x = reorder(state, desc(month_avg)), y = month_avg)) +
    geom_bar(stat = "identity", position = position_dodge(), fill='dark green') +
    labs(
        title = "Trump's Margin", 
        x = "Southern States", 
        y = "Percent Difference") +
    theme(axis.text.x = element_text(angle=90, vjust=0.5, hjust=1),
          plot.title = element_text(hjust = 0.5))

margin_plot2 = 
  vote_margin %>%
  filter(Region == "West") %>% 
    ggplot(aes(x = reorder(state, desc(month_avg)), y = month_avg)) +
    geom_bar(stat = "identity", position = position_dodge(), fill='dark blue') +
    labs(
        title = "Trump's Vote Margin", 
        x = "Western States", 
        y = "Percent Difference") +
    theme(axis.text.x = element_text(angle=90, vjust=0.5, hjust=1),
          plot.title = element_text(hjust = 0.5))

margin_plot3 = 
  vote_margin %>%
  filter(Region == "Northeast") %>% 
    ggplot(aes(x = reorder(state, desc(month_avg)), y = month_avg)) +
    geom_bar(stat = "identity", position = position_dodge(), fill='purple') +
    labs(
        title = "Trump's Raw Vote Margin", 
        x = "Northeaster States", 
        y = "Percent Difference") +
    theme(axis.text.x = element_text(angle=90, vjust=0.5, hjust=1),
          plot.title = element_text(hjust = 0.5))

margin_plot4 = 
  vote_margin %>%
    filter(Region == "Midwest") %>% 
    ggplot(aes(x = reorder(state, desc(month_avg)), y = month_avg)) +
    geom_bar(stat = "identity", position = position_dodge(), fill='dark red') +
    labs(
        title = "Trump's Vote Margin", 
        x = "Midwestern States", 
        y = "Percent Difference") +
    theme(axis.text.x = element_text(angle=90, vjust=0.5, hjust=1),
          plot.title = element_text(hjust = 0.5))

##Combine Plots 
margin_plot1 + margin_plot2 + margin_plot3 + margin_plot4
```

```{r State_Winner, message = FALSE}

state_winner_df =
    exp_votes %>% 
    group_by(State) %>% 
    mutate(state_winner = case_when(
        candidate_votes == max(candidate_votes) ~ TRUE,
        candidate_votes != max(candidate_votes) ~ FALSE)
    ) %>% 
  mutate(region = tolower(State)) %>% 
  filter(state_winner == TRUE) %>% 
  select(-month) %>%
  distinct()

usa_map = map_data("state") 
 
us_election_map = 
  left_join(usa_map, state_winner_df) 

```

Election Map -- More to come 

```{r election_map}

colors <- c("dark red", "dark blue")
names(colors) = c("Trump", "Biden")

election_map=
  ggplot(data = us_election_map,
       aes(x = long, y = lat,
           group = group, fill = Candidate,
            text = paste("State: ", State, 
                  "</br></br>Winning Candidate: ", Candidate, 
                 "</br>Votes: ", candidate_votes, 
                 "</br>Percentage of Votes: ", round(votes_proportion, 2)))) +
    geom_polygon(color = "gray90", size = 0.1) +
    labs(title = "Election Results across states") + 
    scale_fill_manual(values = colors) +
    theme_void() +
    theme(
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), 
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(), 
        legend.position = "bottom") 


        

```

```{r Election_Map_Plotly}
ggplotly(election_map, tooltip = "text")
```

Need Bar Plot of total votes in Each State segamented by Region
Line graph comparing polls and election results 
Add more to map with Plotly: Total votes, number of votes, and proportion of votes for each candidate 
Twitter frequency or number of votes/state winner comparison for predicting candidate winner 
Project report 

